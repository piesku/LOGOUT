(function(){"use strict";function e(e){return"#"===e.charAt(0)&&(e=e.substr(1)),3===e.length&&(e=e.split("").map((e)=>e+e).join("")),e.match(/.{1,2}/g).map((e)=>parseFloat((parseInt(e,16)/255).toFixed(2)))}function t(e){return e.reduce((e,t)=>{let o=(~~(255*t)).toString(16);return 1===o.length&&(o="0"+o),e+o},"#")}function o(e,t,o){let n,r,i;if(0==t)n=r=i=o;else{function a(e,o,n){return 0>n&&(n+=1),1<n&&(n-=1),n<1/6?e+6*(o-e)*n:n<1/2?o:n<2/3?e+6*((o-e)*(2/3-n)):e}let s=0.5>o?o*(1+t):o+t-o*t,m=2*o-s;n=a(m,s,e+1/3),r=a(m,s,e),i=a(m,s,e-1/3)}return[n,r,i]}function n(){let e=new Me(3);return Me!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function r(e,t,o){let n=new Me(3);return n[0]=e,n[1]=t,n[2]=o,n}function i(e,t,o){return e[0]=t[0]+o[0],e[1]=t[1]+o[1],e[2]=t[2]+o[2],e}function a(e,t,o){return e[0]=t[0]-o[0],e[1]=t[1]-o[1],e[2]=t[2]-o[2],e}function s(e,t,o){return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function m(e,t){let o=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2];return ve(o*o+n*n+r*r)}function c(e,t){let o=t[0],n=t[1],r=t[2],i=o*o+n*n+r*r;return 0<i&&(i=1/ve(i),e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i),e}function l(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function d(e,t,o){let n=t[0],r=t[1],i=t[2],a=o[0],s=o[1],m=o[2];return e[0]=r*m-i*s,e[1]=i*a-n*m,e[2]=n*s-r*a,e}function _(e,t,o){let n=t[0],r=t[1],i=t[2],a=o[3]*n+o[7]*r+o[11]*i+o[15];return a=a||1,e[0]=(o[0]*n+o[4]*r+o[8]*i+o[12])/a,e[1]=(o[1]*n+o[5]*r+o[9]*i+o[13])/a,e[2]=(o[2]*n+o[6]*r+o[10]*i+o[14])/a,e}function f(e,t){let o=r(e[0],e[1],e[2]),n=r(t[0],t[1],t[2]);c(o,o),c(n,n);let i=l(o,n);return 1<i?0:-1>i?he:ye(i)}function p(){let e=new Me(16);return Me!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function u(e){let t=new Me(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function g(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function y(e,t){let o=t[0],n=t[1],r=t[2],i=t[3],a=t[4],s=t[5],m=t[6],c=t[7],l=t[8],d=t[9],_=t[10],f=t[11],p=t[12],u=t[13],g=t[14],y=t[15],h=o*s-n*a,v=o*m-r*a,E=o*c-i*a,x=n*m-r*s,b=n*c-i*s,R=r*c-i*m,A=l*u-d*p,S=l*g-_*p,k=l*y-f*p,F=d*g-_*u,T=d*y-f*u,L=_*y-f*g,O=h*L-v*T+E*F+x*k-b*S+R*A;return O?(O=1/O,e[0]=(s*L-m*T+c*F)*O,e[1]=(r*T-n*L-i*F)*O,e[2]=(u*R-g*b+y*x)*O,e[3]=(_*b-d*R-f*x)*O,e[4]=(m*k-a*L-c*S)*O,e[5]=(o*L-r*k+i*S)*O,e[6]=(g*E-p*R-y*v)*O,e[7]=(l*R-_*E+f*v)*O,e[8]=(a*T-s*k+c*A)*O,e[9]=(n*k-o*T-i*A)*O,e[10]=(p*b-u*E+y*h)*O,e[11]=(d*E-l*b-f*h)*O,e[12]=(s*S-a*F-m*A)*O,e[13]=(o*F-n*S+r*A)*O,e[14]=(u*v-p*x-g*h)*O,e[15]=(l*x-d*v+_*h)*O,e):null}function h(e,t,o){let n=t[0],r=t[1],i=t[2],a=t[3],s=t[4],m=t[5],c=t[6],l=t[7],d=t[8],_=t[9],f=t[10],p=t[11],u=t[12],g=t[13],y=t[14],h=t[15],v=o[0],E=o[1],x=o[2],b=o[3];return e[0]=v*n+E*s+x*d+b*u,e[1]=v*r+E*m+x*_+b*g,e[2]=v*i+E*c+x*f+b*y,e[3]=v*a+E*l+x*p+b*h,v=o[4],E=o[5],x=o[6],b=o[7],e[4]=v*n+E*s+x*d+b*u,e[5]=v*r+E*m+x*_+b*g,e[6]=v*i+E*c+x*f+b*y,e[7]=v*a+E*l+x*p+b*h,v=o[8],E=o[9],x=o[10],b=o[11],e[8]=v*n+E*s+x*d+b*u,e[9]=v*r+E*m+x*_+b*g,e[10]=v*i+E*c+x*f+b*y,e[11]=v*a+E*l+x*p+b*h,v=o[12],E=o[13],x=o[14],b=o[15],e[12]=v*n+E*s+x*d+b*u,e[13]=v*r+E*m+x*_+b*g,e[14]=v*i+E*c+x*f+b*y,e[15]=v*a+E*l+x*p+b*h,e}function v(e,t,o,n){let r=t[0],i=t[1],a=t[2],s=t[3],m=r+r,c=i+i,l=a+a,d=r*m,_=r*c,f=r*l,p=i*c,u=i*l,g=a*l,y=s*m,h=s*c,v=s*l,E=n[0],x=n[1],b=n[2];return e[0]=(1-(p+g))*E,e[1]=(_+v)*E,e[2]=(f-h)*E,e[3]=0,e[4]=(_-v)*x,e[5]=(1-(d+g))*x,e[6]=(u+y)*x,e[7]=0,e[8]=(f+h)*b,e[9]=(u-y)*b,e[10]=(1-(d+p))*b,e[11]=0,e[12]=o[0],e[13]=o[1],e[14]=o[2],e[15]=1,e}function E(e,t,o,n,r){let i,a=1/Math.tan(t/2);return e[0]=a/o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==Infinity?(i=1/(n-r),e[10]=(r+n)*i,e[14]=2*r*n*i):(e[10]=-1,e[14]=-2*n),e}function x(e,t,o,n,r,i,a){let s=1/(t-o),m=1/(n-r),c=1/(i-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*m,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+o)*s,e[13]=(r+n)*m,e[14]=(a+i)*c,e[15]=1,e}function b(e,t,o,n){let r,i,a,s,m,c,l,d,_,f,p=t[0],u=t[1],y=t[2],h=n[0],v=n[1],E=n[2],x=o[0],b=o[1],R=o[2];return ue(p-x)<De&&ue(u-b)<De&&ue(y-R)<De?g(e):(l=p-x,d=u-b,_=y-R,f=1/ve(l*l+d*d+_*_),l*=f,d*=f,_*=f,r=v*_-E*d,i=E*l-h*_,a=h*d-v*l,f=ve(r*r+i*i+a*a),f?(f=1/f,r*=f,i*=f,a*=f):(r=0,i=0,a=0),s=d*a-_*i,m=_*r-l*a,c=l*i-d*r,f=ve(s*s+m*m+c*c),f?(f=1/f,s*=f,m*=f,c*=f):(s=0,m=0,c=0),e[0]=r,e[1]=s,e[2]=l,e[3]=0,e[4]=i,e[5]=m,e[6]=d,e[7]=0,e[8]=a,e[9]=c,e[10]=_,e[11]=0,e[12]=-(r*p+i*u+a*y),e[13]=-(s*p+m*u+c*y),e[14]=-(l*p+d*u+_*y),e[15]=1,e)}function R(){let e=new Me(9);return Me!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function A(){let e=new Me(4);return Me!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function S(){let e=new Me(4);return Me!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function k(e,t,o){o*=0.5;let n=pe(o);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=fe(o),e}function F(e,t,o){let n=t[0],r=t[1],i=t[2],a=t[3],s=o[0],m=o[1],c=o[2],l=o[3];return e[0]=n*l+a*s+r*c-i*m,e[1]=r*l+a*m+i*s-n*c,e[2]=i*l+a*c+n*m-r*s,e[3]=a*l-n*s-r*m-i*c,e}function T(e,o,n,r){let t,i,a,s,m,c=o[0],l=o[1],d=o[2],_=o[3],f=n[0],p=n[1],u=n[2],g=n[3];return i=c*f+l*p+d*u+_*g,0>i&&(i=-i,f=-f,p=-p,u=-u,g=-g),1-i>De?(t=ye(i),a=pe(t),s=pe((1-r)*t)/a,m=pe(r*t)/a):(s=1-r,m=r),e[0]=s*c+m*f,e[1]=s*l+m*p,e[2]=s*d+m*u,e[3]=s*_+m*g,e}function L(e,t){let o,n=t[0]+t[4]+t[8];if(0<n)o=ve(n+1),e[3]=0.5*o,o=0.5/o,e[0]=(t[5]-t[7])*o,e[1]=(t[6]-t[2])*o,e[2]=(t[1]-t[3])*o;else{let n=0;t[4]>t[0]&&(n=1),t[8]>t[3*n+n]&&(n=2);let r=(n+1)%3,i=(n+2)%3;o=ve(t[3*n+n]-t[3*r+r]-t[3*i+i]+1),e[n]=0.5*o,o=0.5/o,e[3]=(t[3*r+i]-t[3*i+r])*o,e[r]=(t[3*r+n]+t[3*n+r])*o,e[i]=(t[3*i+n]+t[3*n+i])*o}return e}function O(e,t,o,n){const r=Float32Array.of(...t,...o,...n);return ze(e,L(e,r))}function w(e){return e*he/180}function P(e){const t=Je.createBuffer();return Je.bindBuffer(Je.ARRAY_BUFFER,t),Je.bufferData(Je.ARRAY_BUFFER,new Float32Array(e),Je.STATIC_DRAW),t}function C(e){const t=Je.createBuffer();return Je.bindBuffer(Je.ELEMENT_ARRAY_BUFFER,t),Je.bufferData(Je.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),Je.STATIC_DRAW),t}function D(e,t){const o=Je.createShader(e);if(Je.shaderSource(o,t),Je.compileShader(o),!Je.getShaderParameter(o,Je.COMPILE_STATUS))throw Je.getShaderInfoLog(o);return o}function M(e,t){const o=Je.createProgram();if(Je.attachShader(o,e),Je.attachShader(o,t),Je.linkProgram(o),!Je.getProgramParameter(o,Je.LINK_STATUS))throw Je.getProgramInfoLog(o);return o}function U(e){return`#version 300 es

    ${e.map((e)=>`
      #define ${e}
    `).join("")}

    precision mediump float;

    uniform vec4 c;

    in vec3 fp;

    #ifdef LIGHTS
      #define MAX_LIGHTS 100

      uniform vec3[MAX_LIGHTS] lp;
      uniform vec3[MAX_LIGHTS] lc;
      uniform float[MAX_LIGHTS] li;
      uniform int al;

      in vec3 fn;
    #endif

    #ifdef FOG
      uniform vec3 fog_color;
      uniform vec2 fog_distance;
      in float f_distance;
    #endif

    out vec4 frag_color;

    void main()
    {
      #ifdef FOG
        float fog_factor = clamp((fog_distance.y - f_distance) / (fog_distance.y - fog_distance.x), 0.0, 1.0);
      #endif

      #ifdef LIGHTS
          vec4 p_c = c;

          vec3 n = fn;

        vec4 light = vec4(0.0, 0.0, 0.0, 1.0);
        for (int i = 0; i < al; i++) {
          vec3 light_dir = lp[i] - fp;
          vec3 L = normalize(light_dir);
          float light_dist = length(light_dir);
          float diffuse_factor = max(dot(n, L), 0.0);
          vec3 rgb = p_c.rgb * diffuse_factor * lc[i] * li[i] / light_dist;
          light += vec4(rgb, p_c.a);
        }

        #ifdef FOG
          frag_color = mix(vec4(fog_color, 1.0), light, fog_factor);
        #else
          frag_color = light;
        #endif
      #else
          #ifdef FOG
            frag_color = mix(vec4(fog_color, 1.0), c, fog_factor);
          #else
            frag_color = c;
          #endif
      #endif
    }
  `}function B(e){return`#version 300 es

    ${e.map((e)=>`
      #define ${e}
    `).join("")}

    precision mediump float;

    uniform mat4 p;
    uniform mat4 v;
    uniform mat4 w;

    in vec3 P_current;

    #ifdef LIGHTS
      in vec3 N_current;
      out vec3 fn;
    #endif

    #ifdef FOG
      uniform vec3 camera;
      out float f_distance;
    #endif

    out vec3 fp;

    void main()
    {

        fp = (w * vec4(P_current, 1.0)).xyz;

        #ifdef LIGHTS
          fn = (vec4(N_current, 0.0)).xyz;
        #endif

      gl_Position = p * v * vec4(fp, 1.0);

      #ifdef FOG
        f_distance = distance(w * vec4(P_current, 1.0), vec4(camera, 1.0));
      #endif
    }
  `}function I(e=0,t=1){return _e(gt()*(t-e+1)+e)}function j(e=0,t=1){return gt()*(t-e)+e}function N(e){return e[I(0,e.length-1)]}function H(e){return new $e({components:[new ot({position:e})]})}function q({position:e,scale:t}){let o=new Nt;return o.components.get(rt).set({material:Xt,color:xt,tag:Gt}),o.components.get(ot).set({position:e,scale:t}),o}function G({position:e,color:t,intensity:o}){return new $e({components:[new ot({position:e}),new ht({color:t,intensity:o})]})}function Y({position:e,scale:t,color:o,is_north_south:n,is_negative:r}){let i=H(e),a=new Nt;a.components.get(rt).set({material:Xt,color:o,tag:Yt}),a.components.get(ot).set({scale:t}),i.add(a);let s=G({position:[n?0:r*Rt,0,n?r*Rt:0],color:o,intensity:At});return i.add(s),i}function z({position:e,scale:t,neons:o}){let n=H(e),r=new Nt;r.components.get(rt).set({material:Xt,color:xt,tag:Gt}),r.components.get(ot).set({scale:t}),n.add(r);for(let r of o){let e=Y(r);n.add(e)}return n}function K(e){let t=new Nt;return t.components.get(rt).set({material:Vt,color:kt}),t.components.get(ot).set(e),t.add_component(new Dt({radius:0.6,action:[Ce]})),t.add_component(new Ht({speed:[0,0.0001,0]})),t}function W({system:e,position:t}){let o=new Nt;o.components.get(rt).set({material:Xt,color:kt,tag:zt}),o.components.get(ot).set({position:t}),o.add_component(new Dt({radius:1,action:[Pe,e]})),o.add_component(new Ht({speed:[0.0001,0.0002,0.0003]}));let n=new $e({components:[new ot,new ct({color:kt,intensity:Ft})]});return o.add(n),o}function X(){const e=new _t({width:window.innerWidth,height:window.innerHeight,far:126,clear_color:Et});e.buildings=[],e.perspe_matrix=JSON.parse(JSON.stringify(e.projMatrix)),e.setup_ortho_camera(),document.body.addEventListener("click",()=>document.body.requestPointerLock()),e.camera.components.get(ot).set({position:[Jt.start[0]*vt,1.75,Jt.start[1]*vt]}),e.camera.remove_component(st);const t=new yt;e.camera.add_component(t),t.set({keyboard_controlled:!0,mouse_controlled:!1,move_speed:5,rotate_speed:0}),e.camera.add_component(new Mt),e.camera.add_component(new Ct),e.remove(e.light);let o=q({position:[0,-0.5,0],scale:[10*(Jt.size[0]*vt),1,10*(Jt.size[1]*vt)]});e.add(o);for(let[t,o,n,r,i]of Jt.buildings){let a=ue(n-t)*vt,s=ue(r-o)*vt,m=t*vt+a/2,c=o*vt+s/2,l=i*vt,d=z({position:[m,l/2,c],scale:[a,l,s],neons:Array(I(2,4)).fill(0).map((e,t,o)=>{const n=N([!0,!1]),r=N([1,-1]),i=l*St/(o.length+0.5);return{position:[n?0:r*(a/2)+0.2*r,l/2-(i+0.5)*(t+1),n?r*(s/2)+0.2*r:0],scale:[n?a*St:0.1,i,n?0.1:s*St],color:xt,is_north_south:n,is_negative:r}})});e.add(d),e.buildings.push([m-a/2,m+a/2,c-s/2,c+s/2])}for(let[t,o,n]of Jt.items)e.add(W({system:Le[t],position:[o*vt,1.75,n*vt]}));return window.game=e,e}function J(e){e.add(K({position:[Jt.end[0]*vt,50*vt/2,Jt.end[1]*vt],scale:[5*vt,200,5*vt]}))}function Z(e){e.stop(),e.destroy(),e.canvas.remove()}function $(){let e=j(Lt,Ot);return t(o(0<e?e+1:e,wt,Pt))}function Q(e,t){switch(t){case Re:for(let t of e.components.get(rt))switch(t.tag){case Gt:t.material=Wt,t.color=bt;continue;case Yt:t.material=Kt;continue;case zt:t.material=Vt;}break;case Ae:for(let t of e.components.get(rt))switch(t.tag){case Yt:{let e=$();t.set({color:e});for(let o of t.entity.parent.iterall(ht))o.set({color:e})}}break;case Fe:e.camera.components.get(yt).set({mouse_controlled:!0,rotate_speed:.5});break;default:}}function ee(e){return[...e].map((e)=>e.codePointAt(0)).reduce((e,t)=>e+t,0)}function te(e){let t=ee(e)%20;return to`
        <div class="g">
            <div class="g1 n${t}">${e}</div>
            <div class="g2 n${t}">${e}</div>
            <div class="g3 n${t}">${e}</div>
        </div>
    `}function oe(e,t){for(let o of e.querySelectorAll(".g > div"))o.textContent=t}function ne(e){return to`
        <div class="l">
            ${te(e)}
        </div>
    `}function re(e){return new class extends Ee{before(){clearInterval(this.interval)}after(t){let o=document.createElement("div"),n=e.split("\n")[Symbol.iterator](),r=t.querySelector(".t");this.interval=setInterval(()=>{let e=n.next();e.done?clearInterval(this.interval):(o.innerHTML=ne(e.value),r.appendChild(o.firstElementChild))},100)}render(){return to`
                <div class="m s">
                    <div class="t" digest="${ee(e)}"></div>
                </div>
            `}}}function ie(e,t=[],{align:o="stretch",justify:n="stretch",cls:r=""}={}){return to`
        <div class="b ${e} ${r}"
            style="grid-area: ${e}; align-self: ${o}; justify-self: ${n};">
            ${t.map(ne)}
        </div>
    `}function ae(e){let t=[];for(let[o,n]of Object.entries(e)){let e=n?"Online":"Offline";t.push(`${o} = ${e}`)}return t}function se(e,t,o){return ie(e,["Running analysis",...ae(o),"<div class=e>Assessment complete</div>"],t)}function me(e,t){return new class extends Ee{before(){clearInterval(this.interval)}after(t){let o=document.createElement("div"),n=t.querySelector(`.${e}`);this.interval=setInterval(()=>{n.removeChild(n.firstElementChild),o.innerHTML=ne(ro.next().value),n.appendChild(o.firstElementChild)},1e3)}render(){return ie(e,Array(10).fill(""),t)}}}function ce(e,t){return new class extends Ee{before(){clearInterval(this.interval)}after(t){let o=t.querySelectorAll(`.${e} .l`);this.interval=setInterval(()=>{let e=new Date;for(let[t,n]of o.entries())n.innerHTML=te(io[t].format(e))},1e3)}render(){let o=new Date;return ie(e,[io[0].format(o),io[1].format(o)],t)}}}function le(e,t){return new class extends Ee{before(){game.off("afterrender",this.up)}after(t){let o=t.querySelector(`.${e}`);this.up=game.on("afterrender",()=>{let e=game.camera.components.get(ot).forward,t=0<e[0]?-1:1,n=Math.round(f([0,0,1],e)/mo)*t,r=(ao+ao+ao).slice(so+n,so+n+co);oe(o,r)})}render(){return ie(e,["----"],t)}}}function de(e,t){return new class extends Ee{constructor(){super(),this.nf=new Intl.NumberFormat("en",{minimumFractionDigits:3,maximumFractionDigits:3})}before(){game.off("afterrender",this.up)}after(t){let o=Array.from(t.querySelectorAll(`.${e} .l`)).slice(1);this.up=game.on("afterrender",()=>{let e=game.camera.components.get(ot).matrix,t=[[e[0],e[4],e[8],e[12]],[e[1],e[5],e[9],e[13]],[e[2],e[6],e[10],e[14]],[e[3],e[7],e[11],e[15]]];for(let[e,n]of o.entries())oe(n,t[e].map((e)=>this.nf.format(e)).join(" "))})}render(){return ie(e,["Avatar entity matrix","1","2","3","4"],t)}}}var _e=Math.floor,fe=Math.cos,pe=Math.sin,ue=Math.abs,ge=Math.min,ye=Math.acos,he=Math.PI,ve=Math.sqrt;class Ee{before(){}render(){}after(){}}const xe="Heads-Up Display",be="Perspective",Re="Light Sensor",Ae="Chromatic Sampling",Se="Low-Res Timer",ke="Compass",Fe="Gimbal Mount",Te="WASD Movement";var Le=Object.freeze({HUD:xe,PERSPECTIVE:be,SOLID:Re,COLOR:Ae,CLOCK:Se,COMPASS:ke,MOUSELOOK:Fe,GRID:Te});const Oe=0,we=1,Pe=2,Ce=3,De=1e-6;let Me="undefined"==typeof Float32Array?Array:Float32Array;const Ue=function(e){let t=e[0],o=e[1],n=e[2];return ve(t*t+o*o+n*n)},Be=function(){let e=n();return function(t,o,n,r,a,s){let m,i;for(o||(o=3),n||(n=0),i=r?ge(r*o+n,t.length):t.length,m=n;m<i;m+=o)e[0]=t[m],e[1]=t[m+1],e[2]=t[m+2],a(e,e,s),t[m]=e[0],t[m+1]=e[1],t[m+2]=e[2];return t}}(),Ie=Float32Array,V=Ie.of(0,0,0),je=Ie.of(1,1,1),Ne=Ie.of(1,0,0),He=Ie.of(0,1,0),qe=Ie.of(0,0,1),Ge=(...e)=>Ie.of(...e),Ye=function(){let e=A();return function(t,o,n,r,a,s){let m,i;for(o||(o=4),n||(n=0),i=r?ge(r*o+n,t.length):t.length,m=n;m<i;m+=o)e[0]=t[m],e[1]=t[m+1],e[2]=t[m+2],e[3]=t[m+3],a(e,e,s),t[m]=e[0],t[m+1]=e[1],t[m+2]=e[2],t[m+3]=e[3];return t}}(),ze=function(e,t){let o=t[0],n=t[1],r=t[2],i=t[3],a=o*o+n*n+r*r+i*i;return 0<a&&(a=1/ve(a),e[0]=o*a,e[1]=n*a,e[2]=r*a,e[3]=i*a),e},Ke=function(){let e=n(),t=r(1,0,0),o=r(0,1,0);return function(n,r,i){let a=l(r,i);return-0.999999>a?(d(e,t,r),1e-6>Ue(e)&&d(e,o,r),c(e,e),k(n,e,Math.PI),n):0.999999<a?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(d(e,r,i),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=1+a,ze(n,n))}}(),Ve=function(){let e=S(),o=S();return function(n,r,i,a,s,m){return T(e,r,s,m),T(o,i,a,m),T(n,e,o,2*m*(1-m)),n}}(),We=function(){let e=R();return function(t,o,n,r){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=r[0],e[4]=r[1],e[7]=r[2],e[2]=-o[0],e[5]=-o[1],e[8]=-o[2],ze(t,L(t,e))}}(),Xe=document.createElement("canvas"),Je=Xe.getContext("webgl2"),Ze={components:[],skip:!1};class $e{constructor(e={}){Object.assign(this,Ze,e),this.entities=new Set,this.components=new Map;for(let t of e.components)this.add_component(t)}add_component(e){e.entity=this,e.mount(),this.components.set(e.constructor,e),this.game&&(!this.game.components.has(e.constructor)&&this.game.components.set(e.constructor,new Set),this.game.components.get(e.constructor).add(e))}remove_component(e){let t=this.components.get(e);this.components.delete(e),this.game&&this.game.components.has(e)&&this.game.components.get(e).delete(t)}*iterall(e){for(let t of this.entities)t.components.has(e)&&(yield t.components.get(e)),yield*t.iterall(e)}add(e){e.parent=this,this.entities.add(e),this.game&&this.game.track_entity(e)}update(e){if(!this.skip){const t=(t)=>t.update(e);this.components.forEach(t),this.entities.forEach(t)}}render(e){if(!this.skip){const t=(t)=>t.render(e);this.components.forEach(t),this.entities.forEach(t)}}}const Qe={entity:null};class et{constructor(e){Object.assign(this,Qe,e)}static get features(){return[]}mount(){}set(e){Object.assign(this,e)}update(){}render(){}}const tt={_scale:je.slice(),_rotation:S(),scale:je.slice(),position:V.slice(),rotation:S()};class ot extends et{constructor(e){super(Object.assign({matrix:p(),world_matrix:p(),world_to_self:p()},tt,e))}get up(){const e=this.matrix.slice(4,7);return c(e,e)}get forward(){const e=this.matrix.slice(8,11);return c(e,e)}set position(e){v(this.matrix,this.rotation,e,this.scale)}get position(){return this.matrix.slice(12,15)}set scale(e){this._scale=e,v(this.matrix,this.rotation,this.position,e)}get scale(){return this._scale}set rotation(e){this._rotation=e,v(this.matrix,e,this.position,this.scale)}get rotation(){return this._rotation}look_at(e){const t=V.slice();a(t,e,this.position),c(t,t);const o=Ge(t[2],0,-t[0]);c(o,o);const n=V.slice();d(n,t,o);const r=S();O(r,o,n,t),this.rotation=r}rotate_along(e,t){const o=S();k(o,e,t),F(o,this.rotation,o),this.rotation=o}rotate_rl(e){this.rotate_along(He,e)}rotate_ud(e){this.rotate_along(Ne,e)}translate(e){const t=V.slice();i(t,this.position,e),this.position=t}get_view_matrix(e){const t=[];return i(t,this.position,this.forward),b(e,this.position,t,this.up),e}update(){this.entity.parent?h(this.world_matrix,this.entity.parent.components.get(ot).world_matrix,this.matrix):this.world_matrix=this.matrix.slice(),y(this.world_to_self,this.world_matrix)}}const nt={material:null,vertices:[],indices:[],normals:[],uvs:[],color:"fff",opacity:1};class rt extends et{constructor(e){super(e),Object.assign(this,nt,e),this.create_buffers()}set color(t){this._color=t||"fff",this.color_vec=[...e(this._color),this.opacity]}get color(){return this._color}create_buffers(){this.buffers={vertices:P(this.vertices),indices:C(this.indices),qty:this.indices.length,normals:P(this.normals),uvs:P(this.uvs)}}render(){this.material.render(this.entity)}}const it=3,at={keyboard_controlled:!1,mouse_controlled:!1,move_speed:3.5,rotate_speed:.5,dir_desc:{37:"yl",38:"pu",39:"yr",40:"pd",65:"l",68:"r",69:"u",81:"d",83:"b",87:"f"}};class st extends et{constructor(e){super(e),Object.assign(this,at,e)}handle_keys(e,{f:t=0,b:o=0,l:n=0,r:i=0,u:r=0,d:m=0,pu:l=0,pd:d=0,yl:f=0,yr:p=0}){const u=this.entity.components.get(ot),g=e/1e3*this.move_speed,y=Ge(n-i,0,t-o);_(y,y,u.matrix),a(y,y,u.position),y[1]=r-m,c(y,y),s(y,y,g),u.translate(y);this.handle_mouse(e,{x:f*it-p*it,y:l*it-d*it})}handle_mouse(e,{x:t,y:o}){const n=this.entity.components.get(ot);if(0!==t||0!==o){const r=e/1e3,i=this.rotate_speed*r*t,a=this.rotate_speed*r*o,s=Ge(fe(a)*pe(i),pe(a),fe(a)*fe(i));c(s,s),_(s,s,n.matrix),n.look_at(s)}}update(e){if(this.keyboard_controlled&&this.entity.game){const t={};for(const[e,o]of Object.entries(this.dir_desc))t[o]=this.entity.game.get_key(e);this.handle_keys(e,t)}this.mouse_controlled&&this.entity.game&&this.handle_mouse(e,this.entity.game.mouse_delta)}}const mt={intensity:0.5,color:"#ffffff"};class ct extends et{constructor(e){super(Object.assign(mt,e))}set color(t){this._color=t||"fff",this.color_vec=[...e(this._color)]}get color(){return this._color}}const lt={canvas:Xe,width:800,height:600,dom:document.body,fps:60,running:!0,fov:60,near:0.35,far:85,left:-10,right:10,bottom:-10,top:10,clear_color:"#FFFFFF",clear_opacity:1,projection:"perspective"},dt=["keydown","keyup","mousemove"];class _t{constructor(e){Object.assign(this,lt,e),this.canvas.width=this.width,this.canvas.height=this.height,this.dom.appendChild(Xe),this.reset(),this.camera=new $e({components:[new ot,new st]}),this.camera.game=this,this.light=new $e({components:[new ot,new ct]}),this.add(this.light),this.projMatrix=p(),this.viewMatrix=p(),"ortho"===this.projection?this.setup_ortho_camera():this.setup_perspective_camera(),this.tick_delta=1e3/this.fps;for(const t of dt){const e="on"+t;this[e]=this[e].bind(this),window.addEventListener(t,this[e])}this.running&&this.start(),Je.enable(Je.CULL_FACE),Je.enable(Je.DEPTH_TEST),Je.clear(Je.DEPTH_BUFFER_BIT|Je.COLOR_BUFFER_BIT)}setup_ortho_camera(){x(this.projMatrix,this.left,this.right,this.bottom,this.top,this.near,this.far)}setup_perspective_camera(){E(this.projMatrix,w(this.fov),this.width/this.height,this.near,this.far)}get clear_color(){return this._clear_color}set clear_color(t){this._clear_color=t;const o=e(t);Je.clearColor(o[0],o[1],o[2],this.clear_opacity)}set clear_opacity(t){this._clear_opacity=t;const o=e(this._clear_color);Je.clearColor(o[0],o[1],o[2],this._clear_opacity)}get clear_opacity(){return this._clear_opacity}stop(){this.running=!1}start(){this.running=!0,this.last_tick=performance.now(),window.requestAnimationFrame((e)=>this.frame(e))}reset(){this.entities=new Set,this.listeners=new Map,this.keys={},this.mouse_delta={x:0,y:0},this.components=new WeakMap}destroy(){for(const e of dt)window.removeEventListener(e,this[e])}emit(e,...t){if(this.listeners.has(e))for(const o of this.listeners.get(e))o(...t)}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),t}off(e,t){this.listeners.has(e)&&this.listeners.get(e).delete(t)}onkeydown(t){this.keys[t.keyCode]=1}onkeyup(t){this.keys[t.keyCode]=0}get_key(e){return this.keys[e]||0}onmousemove(t){this.mouse_delta.x-=t.movementX,this.mouse_delta.y-=t.movementY}frame(e){if(this.running&&window.requestAnimationFrame((e)=>this.frame(e)),e>this.last_tick+this.tick_delta){const t=e-this.last_tick,o=_e(t/this.tick_delta);this.perform_ticks(o),this.render()}}perform_ticks(e){this.mouse_delta.x/=e,this.mouse_delta.y/=e;for(let t=0;t<e;t++)this.last_tick+=this.tick_delta,this.update();this.mouse_delta.x=0,this.mouse_delta.y=0}update(){this.emit("tick",this.last_tick),this.entities.forEach((e)=>e.update(this.tick_delta)),this.camera.update(this.tick_delta),this.camera.components.get(ot).get_view_matrix(this.viewMatrix)}render(){Je.clear(Je.COLOR_BUFFER_BIT|Je.DEPTH_BUFFER_BIT),Je.viewport(0,0,this.canvas.width,this.canvas.height),this.entities.forEach((e)=>e.render()),this.emit("afterrender")}track_entity(e){e.game=this;for(let t of e.components.values())this.components.has(t.constructor)||this.components.set(t.constructor,new Set),this.components.get(t.constructor).add(t);for(let t of e.entities)this.track_entity(t)}untrack_entity(e){e.game=null;for(let t of e.components.values())this.components.get(t.constructor).delete(t);for(let t of e.entities)this.untrack_entity(t)}add(e){this.entities.add(e),this.track_entity(e)}remove(e){this.entities.delete(e),this.untrack_entity(e)}}class ft{constructor(e){this.to=e.to,this.time=e.time||1e3,this.game=e.game,this.object=e.object,this.property=e.property,this.cb=e.cb}do_step(e){this.current_step=ge(1,(e-this.first_tick)/this.tick_delta*this.step),this.action()}action(){}pre_start(){this.tick_delta=this.game.tick_delta,this.first_tick=this.game.last_tick,this.number_of_ticks=Math.ceil(this.time/this.tick_delta),this.step=1/this.number_of_ticks}start(){return this.pre_start(),new Promise((e)=>{const t=(o)=>{1===this.current_step?(this.game.off("tick",t),e()):this.do_step(o,e)};this.game.on("tick",t)})}}class pt{constructor(e={}){this.uniforms={},this.attribs={},this.draw_mode=Je.TRIANGLES,this.features=new Set([].concat(...Array.from(e.requires||[]).map((e)=>e.features))),this._textures={},this.texture=e.texture||!1,this.normal_map=e.normal_map||!1}add_feature(e){this.features.add(e)}has_feature(e){return this.features.has(e)}remove_feature(e){this.features.delete(e)}add_fog(e={}){this.add_feature("FOG"),this.fog={color:e.color||new Float32Array([0,0,0]),distance:e.distance||new Float32Array([10,30])},this.setup_program()}setup_program(){return this.program=M(D(Je.VERTEX_SHADER,B(Array.from(this.features))),D(Je.FRAGMENT_SHADER,U(Array.from(this.features)))),this.program.error?void console.log(this.program.error):void this.get_locations()}get_uniforms_and_attrs(e,t){e.forEach((e)=>{this.uniforms[e]=Je.getUniformLocation(this.program,e)}),t.forEach((e)=>{this.attribs[e]=Je.getAttribLocation(this.program,e)})}set texture(e){this.build_texture(e,this._texture_image,"TEXTURE","gl_texture")}get texture(){return this._texture_image}set normal_map(e){this.build_texture(e,this._normal_map_image,"NORMAL_MAP","gl_normal_map")}get normal_map(){return this._normal_map_image}build_texture(e,t,o,n){e?(!this._textures[n]&&(this._textures[n]=Je.createTexture()),e.then((e)=>{t!==e&&(t=e,Je.bindTexture(Je.TEXTURE_2D,this._textures[n]),Je.texImage2D(Je.TEXTURE_2D,0,Je.RGBA,Je.RGBA,Je.UNSIGNED_BYTE,e),Je.generateMipmap(Je.TEXTURE_2D),!this.has_feature(o)&&(this.add_feature(o),this.setup_program()))}).catch(console.error)):!e&&(t=null,this.remove_feature(o),this.setup_program())}render(e){let t=e,o=t.game;for(;t.parent&&!o;)t=t.parent,o=t.game;Je.useProgram(this.program),Je.uniformMatrix4fv(this.uniforms.p,Je.FALSE,o.projMatrix),Je.uniformMatrix4fv(this.uniforms.v,Je.FALSE,o.viewMatrix),Je.uniformMatrix4fv(this.uniforms.w,Je.FALSE,e.components.get(ot).world_matrix),Je.uniform4fv(this.uniforms.c,e.components.get(rt).color_vec),this.apply_shader(e,o)}}let ut=132079672568928;const gt=function(){return ut=16807*ut%2147483647,(ut-1)/2147483646};class yt extends st{constructor(){super(),delete this.dir_desc[69],delete this.dir_desc[81],this.tick=0,this.size=0.5}mount(){this.transform=this.entity.components.get(ot),this.buildings=window.bul=this.entity.game.buildings,this.last_position=this.transform.position}is_colliding(){const{position:e}=this.transform;return this.buildings.some((t)=>e[0]+this.size>=t[0]&&e[0]-this.size<=t[1]&&e[2]+this.size>=t[2]&&e[2]-this.size<=t[3])}update(e){this.tick++,this.is_colliding()?this.transform.position=this.last_position:(0==this.tick%10&&(this.last_position=this.transform.position),super.update(e))}}class ht extends et{set(e){super.set(e),this.active&&this.entity.components.get(ct).set(e)}on(){this.active=!0;let{color:e,intensity:t}=this;this.entity.add_component(new ct({color:e,intensity:t}))}off(){this.active=!1,this.entity.remove_component(ct)}}const vt=4,Et="333",xt="888",bt="222",Rt=2,At=10,St=0.8,kt="fff",Ft=5,Tt=30,Lt=-.09,Ot=.55,wt=.9,Pt=.6;class Ct extends et{update(){let e=this.entity.components.get(ot),t=e.world_matrix.slice(12,15),o=this.entity.game.components.get(ht);for(let e of o){let o=e.entity.components.get(ot),n=o.world_matrix.slice(12,15),r=m(t,n);if(r>Tt&&e.active){e.off();continue}r<=Tt&&!e.active&&e.on()}}}class Dt extends et{mount(){this.transform=this.entity.components.get(ot)}contains(e){let t=V.slice();return _(t,e,this.transform.world_to_self),t.map(Math.abs).every((e)=>e<=this.radius)}trigger(){this.entity.game.remove(this.entity),dispatch(...this.action)}}class Mt extends et{mount(){this.transform=this.entity.components.get(ot)}update(){let e=this.entity.game.components.get(Dt);for(let t of e)t.contains(this.transform.position)&&t.trigger()}}const Ut=[0.5,0.5,0.5,0.5,0.5,-0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,-0.5,-0.5,0.5,-0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,0.5,0.5,-0.5,-0.5,0.5,-0.5,0.5,-0.5,-0.5,-0.5,-0.5,-0.5],Bt=[0,2,1,2,3,1,4,6,5,6,7,5,8,10,9,10,11,9,12,14,13,14,15,13,16,18,17,18,19,17,20,22,21,22,23,21],It=[1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1],jt=[0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1];class Nt extends $e{constructor(e={}){e.components=[new ot,new rt({vertices:Ut,indices:Bt,normals:It,material:e.material,uvs:jt})],super(e)}}class Ht extends et{mount(){this.transform=this.entity.components.get(ot)}update(e){let[t,o,n]=this.speed;this.transform.rotate_along(Ne,t*e),this.transform.rotate_along(He,o*e),this.transform.rotate_along(qe,n*e)}}class qt extends pt{constructor(e){super(e),this.setup_program()}get_locations(){this.get_uniforms_and_attrs(["p","v","w","c","frame_delta","fog_color","fog_distance","camera"],["P_current","P_next","a_t"])}apply_shader(e,t){const o=e.components.get(rt);let n=o.buffers;o.material.has_feature("FOG")&&(Je.uniform3fv(this.uniforms.fog_color,this.fog.color),Je.uniform2fv(this.uniforms.fog_distance,this.fog.distance),Je.uniform3fv(this.uniforms.camera,t.camera.components.get(ot).position)),Je.bindBuffer(Je.ARRAY_BUFFER,n.vertices),Je.vertexAttribPointer(this.attribs.P_current,3,Je.FLOAT,Je.FALSE,0,0),Je.enableVertexAttribArray(this.attribs.P_current),Je.bindBuffer(Je.ELEMENT_ARRAY_BUFFER,n.indices),Je.drawElements(this.draw_mode,n.qty,Je.UNSIGNED_SHORT,0)}}const Gt=1,Yt=2,zt=3;let Kt=new qt;Kt.add_fog({color:e(Et),distance:new Float32Array([25,100])});let Vt=new qt,Wt=new class extends pt{constructor(e){super(e),this.add_feature("LIGHTS"),this.setup_program()}get_locations(){this.get_uniforms_and_attrs(["p","v","w","lp","li","lc","al","c","u_t","n_m","frame_delta","fog_color","fog_distance","camera"],["P_current","P_next","N_current","N_next","a_t"])}apply_shader(e,t){const o=e.components.get(rt);let n=o.buffers;o.material.has_feature("FOG")&&(Je.uniform3fv(this.uniforms.fog_color,this.fog.color),Je.uniform2fv(this.uniforms.fog_distance,this.fog.distance),Je.uniform3fv(this.uniforms.camera,t.camera.components.get(ot).position)),Je.bindBuffer(Je.ARRAY_BUFFER,n.vertices),Je.vertexAttribPointer(this.attribs.P_current,3,Je.FLOAT,Je.FALSE,0,0),Je.enableVertexAttribArray(this.attribs.P_current),Je.bindBuffer(Je.ARRAY_BUFFER,n.normals),Je.vertexAttribPointer(this.attribs.N_current,3,Je.FLOAT,Je.FALSE,0,0),Je.enableVertexAttribArray(this.attribs.N_current),Je.bindBuffer(Je.ELEMENT_ARRAY_BUFFER,n.indices),Je.drawElements(this.draw_mode,n.qty,Je.UNSIGNED_SHORT,0);const r=Array.from(t.components.get(ct)),a=r.length;let s=new Float32Array(3*a),m=new Float32Array(3*a),c=new Float32Array(a);for(let o=0;o<a;o++){let e=r[o].entity.components.get(ot),t=e.world_matrix.slice(12,15);s.set(t,3*o),m.set(r[o].color_vec,3*o),c[o]=r[o].intensity}Je.uniform1i(this.uniforms.al,a),Je.uniform3fv(this.uniforms.lp,s),Je.uniform3fv(this.uniforms.lc,m),Je.uniform1fv(this.uniforms.li,c)}};Wt.add_fog({color:e(Et),distance:new Float32Array([0,40])});let Xt=new class extends qt{constructor(e){super(e),this.draw_mode=Je.LINE_STRIP}};var Jt={size:[63,63],buildings:[[56,0,63,4,26],[46,0,54,3,37],[25,0,32,2,35],[17,0,23,6,39],[8,0,13,3,35],[0,0,8,12,30],[24,3,32,8,8],[35,4,42,7,32],[32,4,35,7,21],[60,5,63,13,23],[58,5,60,10,16],[46,5,58,8,6],[8,5,12,13,4],[42,6,46,11,8],[35,7,39,9,17],[21,8,27,12,7],[12,8,21,11,21],[48,12,54,18,28],[16,12,18,15,4],[0,12,5,16,13],[57,13,63,16,6],[44,13,46,20,18],[33,13,37,17,8],[11,13,14,16,16],[8,13,11,16,20],[42,14,44,17,15],[24,14,31,16,18],[60,16,63,24,32],[16,16,22,18,6],[11,16,14,19,12],[8,16,11,19,24],[0,16,4,24,21],[28,17,30,20,4],[24,17,27,23,8],[34,19,36,20,3],[17,19,22,21,3],[51,20,54,25,18],[37,20,40,23,3],[33,20,36,23,4],[50,21,51,22,17],[46,21,48,24,3],[43,21,46,27,5],[28,21,31,28,3],[17,21,22,24,18],[11,21,15,24,9],[4,21,9,27,3],[56,22,60,27,8],[39,24,40,26,2],[37,24,39,29,3],[33,24,35,27,4],[24,24,28,28,11],[19,25,22,30,5],[60,26,63,31,26],[0,26,3,34,34],[51,27,54,30,17],[48,27,51,30,6],[4,27,6,33,15],[41,28,46,32,14],[33,28,36,31,5],[57,29,60,40,9],[25,29,29,32,2],[24,29,25,31,1],[48,30,54,33,20],[19,30,22,31,3],[6,31,10,34,4],[61,33,63,38,29],[21,33,23,40,13],[33,34,36,39,21],[28,34,31,39,17],[17,34,20,37,8],[8,34,13,38,10],[48,35,52,40,13],[44,35,47,44,20],[36,35,41,38,13],[24,35,27,40,3],[15,35,17,38,5],[0,36,8,39,28],[3,39,6,47,21],[54,40,63,43,20],[33,40,39,45,30],[24,40,31,43,5],[16,40,19,42,7],[10,40,14,44,14],[47,41,51,44,15],[16,42,22,44,11],[55,43,63,46,11],[25,44,30,46,8],[52,46,56,52,5],[17,46,21,48,8],[9,46,13,58,10],[58,47,63,54,35],[45,47,50,52,31],[0,47,9,51,3],[34,49,41,52,5],[24,50,29,57,16],[15,50,18,54,28],[20,51,24,54,19],[53,52,56,55,19],[34,52,43,55,23],[0,53,7,63,35],[44,54,53,58,9],[31,55,44,58,17],[57,56,63,63,28],[23,57,31,63,41],[9,58,23,61,17],[46,59,54,63,36],[34,60,42,63,38]],start:[33,18],end:[15,28],items:[["COMPASS",47,25],["CLOCK",23,50],["SOLID",48,45],["COLOR",37,30],["MOUSELOOK",32,26]]};const Zt={view:"intro",systems:{[xe]:!1,[be]:!1,[Re]:!1,[Ae]:!1,[Se]:!1,[ke]:!1,[Fe]:!1,[Te]:!0}},{attach:$t,connect:Qt,dispatch:eo,html:to}=function(e){function t(e){if(e instanceof Ee){let t=e.render();return"BEFORE"===n?e.before(r):"AFTER"===n?e.after(r):t}return e}function o(e){let o=a;n="BEFORE",a=o,t(i()),n="RENDER",a=e,r.innerHTML=t(i()),n="AFTER",a=e,t(i())}let n,r,i,a=e();return{attach(e,t){r=t,i=e,o(a)},connect(e){return(...t)=>e(a,...t)},dispatch(t,...n){let r=e(a,t,n);o(r)},html([e,...o],...n){return n.reduce((e,n)=>e.concat(t(n),o.shift()),[e]).filter((e)=>e&&!0!==e||0===e).join("")}}}(function(e=Zt,t,o){switch(t){case Oe:return Object.assign({},e,{view:"diag"});case we:return document.body.requestPointerLock(),Object.assign({},e,{view:"play",game:X(),last:xe,systems:Object.assign({},e.systems,{[xe]:!0})});case Pe:{let[t]=o;Q(game,t);let n=[...Object.values(e.systems)],r=n.filter((e)=>e);return 1==n.length-r.length&&J(game),Object.assign({},e,{last:t,systems:Object.assign({},e.systems,{[t]:!0})})}case Ce:return document.exitPointerLock(),Z(e.game),Object.assign({},e,{view:"outro"});default:return e;}}),oo=`
<div class="h">LOGOUT</div>

In 2018, people live their lives in virtual reality.
Most never leave the community clusters assigned
to them at birth. A handful of lucky ones migrate
to premium clusters which boast 100% uptime.

You are not one of the lucky ones.

The community VR cluster you've spent your life in
has had a critical failure. The reboot has reset
the entire world.

Find the exit and log out into the reality.

<button onclick="dispatch(${Oe})">Run system diagnostic</button>
`,no=`\
Initiating logout sequence…

Reticulating splines…
Stopping services…
Clearing caches…

Logout complete

<a href="https://twitter.com/hashtag/js13k">Enter the real world</a>
`;var ro=function*(){for(let e=U.toString().split("\n").slice(7,-2).map((e)=>e.trim()).filter(Boolean),t=0;;)yield e[t++%e.length]}();const io=[new Intl.DateTimeFormat("en",{weekday:"short",month:"short",day:"2-digit",year:"numeric"}),new Intl.DateTimeFormat("en",{hour:"2-digit",minute:"2-digit",second:"2-digit"})];let ao="NW ---- N ---- NE ---- E ---- SE ---- S ---- SW ---- W ---- ",so=ao.length;ao=ao+ao+ao;let mo=2*he/so,co=18;class lo extends ft{action(){for(let e=0;e<this.from.length;e++)this.object[e]=this.from[e]+this.current_step*(this.to[e]-this.from[e])}pre_start(){super.pre_start(),this.from=u(this.object)}}var _o=Qt(function({game:e,last:t,systems:o}){return new class extends Ee{after(){t===xe&&(setTimeout(()=>new lo({object:e.projMatrix,to:e.perspe_matrix,time:3e3,game:e}).start(),5e3),setTimeout(()=>dispatch(Pe,be),7e3))}render(){return to`
                <div class="m u">
                    ${o[xe]&&se("tl",{},o)}

                    ${o[ke]&&le("tm",{justify:"center"})}

                    ${o[Se]&&ce("tr",{justify:"end"})}

                    ${ie("mm",[t,"<div class='h e'>Activated</div>"],{align:"center",justify:"center",cls:"f"})}

                    ${o[xe]&&ie("mr",["Active objectives","> 01. Bring Systems Online","> 02. Locate exit","> 03. Init logout sequence"])}

                    ${o[be]&&de("bl",{align:"end"})}

                    ${o[Re]&&me("br",{align:"end"})}
                </div>
            `}}}),fo=Qt(function({view:e,systems:t}){switch(e){case"intro":return re(oo);case"diag":let o=["Running analysis\u2026\n",...ae(t),`\n<button onclick="dispatch(${we})">Initiate recovery sequence</button>`].join("\n");return re(o);case"play":return _o();case"outro":return re(no);}});let po=document.styleSheets[0],uo=20,go=new Intl.NumberFormat("en",{style:"percent"});for(let e=0;20>e;e++)po.insertRule(`
        @keyframes n${e} {
            ${Array(uo).fill(1).map((e,t)=>`
                ${go.format(t/uo)} {
                    clip-path: inset(
                        ${go.format(Math.random())} 0
                        ${go.format(Math.random())}
                    );
                }
            `).join("")}
        }
    `),po.insertRule(`
        .g2.n${e} {
            animation: n${e} ${5*Math.random()}s linear infinite alternate;
        }
    `),po.insertRule(`
        .g3.n${e} {
            animation: n${e} ${5*Math.random()}s linear infinite alternate;
        }
    `);$t(fo,document.querySelector("#root")),window.dispatch=eo})();
