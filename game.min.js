(function(){"use strict";function e(e){return"#"===e.charAt(0)&&(e=e.substr(1)),3===e.length&&(e=e.split("").map((e)=>e+e).join("")),e.match(/.{1,2}/g).map((e)=>parseFloat((parseInt(e,16)/255).toFixed(2)))}function t(e){return e.reduce((e,t)=>{let o=(~~(255*t)).toString(16);return 1===o.length&&(o="0"+o),e+o},"#")}function o(e,t,o){let n,r,i;if(0==t)n=r=i=o;else{function a(e,o,n){return 0>n&&(n+=1),1<n&&(n-=1),n<1/6?e+6*(o-e)*n:n<1/2?o:n<2/3?e+6*((o-e)*(2/3-n)):e}let s=0.5>o?o*(1+t):o+t-o*t,c=2*o-s;n=a(c,s,e+1/3),r=a(c,s,e),i=a(c,s,e-1/3)}return[n,r,i]}function n(){let e=new Ue(3);return Ue!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function r(e,t,o){let n=new Ue(3);return n[0]=e,n[1]=t,n[2]=o,n}function i(e,t,o){return e[0]=t[0]+o[0],e[1]=t[1]+o[1],e[2]=t[2]+o[2],e}function a(e,t,o){return e[0]=t[0]-o[0],e[1]=t[1]-o[1],e[2]=t[2]-o[2],e}function s(e,t,o){return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function c(e,t){let o=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2];return Ee(o*o+n*n+r*r)}function m(e,t){let o=t[0],n=t[1],r=t[2],i=o*o+n*n+r*r;return 0<i&&(i=1/Ee(i),e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i),e}function l(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function d(e,t,o){let n=t[0],r=t[1],i=t[2],a=o[0],s=o[1],c=o[2];return e[0]=r*c-i*s,e[1]=i*a-n*c,e[2]=n*s-r*a,e}function _(e,t,o){let n=t[0],r=t[1],i=t[2],a=o[3]*n+o[7]*r+o[11]*i+o[15];return a=a||1,e[0]=(o[0]*n+o[4]*r+o[8]*i+o[12])/a,e[1]=(o[1]*n+o[5]*r+o[9]*i+o[13])/a,e[2]=(o[2]*n+o[6]*r+o[10]*i+o[14])/a,e}function f(e,t){let o=r(e[0],e[1],e[2]),n=r(t[0],t[1],t[2]);m(o,o),m(n,n);let i=l(o,n);return 1<i?0:-1>i?he:ve(i)}function p(){let e=new Ue(16);return Ue!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function u(e){let t=new Ue(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function g(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function y(e,t){let o=t[0],n=t[1],r=t[2],i=t[3],a=t[4],s=t[5],c=t[6],m=t[7],l=t[8],d=t[9],_=t[10],f=t[11],p=t[12],u=t[13],g=t[14],y=t[15],v=o*s-n*a,h=o*c-r*a,E=o*m-i*a,x=n*c-r*s,b=n*m-i*s,R=r*m-i*c,A=l*u-d*p,S=l*g-_*p,k=l*y-f*p,F=d*g-_*u,L=d*y-f*u,T=_*y-f*g,O=v*T-h*L+E*F+x*k-b*S+R*A;return O?(O=1/O,e[0]=(s*T-c*L+m*F)*O,e[1]=(r*L-n*T-i*F)*O,e[2]=(u*R-g*b+y*x)*O,e[3]=(_*b-d*R-f*x)*O,e[4]=(c*k-a*T-m*S)*O,e[5]=(o*T-r*k+i*S)*O,e[6]=(g*E-p*R-y*h)*O,e[7]=(l*R-_*E+f*h)*O,e[8]=(a*L-s*k+m*A)*O,e[9]=(n*k-o*L-i*A)*O,e[10]=(p*b-u*E+y*v)*O,e[11]=(d*E-l*b-f*v)*O,e[12]=(s*S-a*F-c*A)*O,e[13]=(o*F-n*S+r*A)*O,e[14]=(u*h-p*x-g*v)*O,e[15]=(l*x-d*h+_*v)*O,e):null}function v(e,t,o){let n=t[0],r=t[1],i=t[2],a=t[3],s=t[4],c=t[5],m=t[6],l=t[7],d=t[8],_=t[9],f=t[10],p=t[11],u=t[12],g=t[13],y=t[14],v=t[15],h=o[0],E=o[1],x=o[2],b=o[3];return e[0]=h*n+E*s+x*d+b*u,e[1]=h*r+E*c+x*_+b*g,e[2]=h*i+E*m+x*f+b*y,e[3]=h*a+E*l+x*p+b*v,h=o[4],E=o[5],x=o[6],b=o[7],e[4]=h*n+E*s+x*d+b*u,e[5]=h*r+E*c+x*_+b*g,e[6]=h*i+E*m+x*f+b*y,e[7]=h*a+E*l+x*p+b*v,h=o[8],E=o[9],x=o[10],b=o[11],e[8]=h*n+E*s+x*d+b*u,e[9]=h*r+E*c+x*_+b*g,e[10]=h*i+E*m+x*f+b*y,e[11]=h*a+E*l+x*p+b*v,h=o[12],E=o[13],x=o[14],b=o[15],e[12]=h*n+E*s+x*d+b*u,e[13]=h*r+E*c+x*_+b*g,e[14]=h*i+E*m+x*f+b*y,e[15]=h*a+E*l+x*p+b*v,e}function h(e,t,o,n){let r=t[0],i=t[1],a=t[2],s=t[3],c=r+r,m=i+i,l=a+a,d=r*c,_=r*m,f=r*l,p=i*m,u=i*l,g=a*l,y=s*c,v=s*m,h=s*l,E=n[0],x=n[1],b=n[2];return e[0]=(1-(p+g))*E,e[1]=(_+h)*E,e[2]=(f-v)*E,e[3]=0,e[4]=(_-h)*x,e[5]=(1-(d+g))*x,e[6]=(u+y)*x,e[7]=0,e[8]=(f+v)*b,e[9]=(u-y)*b,e[10]=(1-(d+p))*b,e[11]=0,e[12]=o[0],e[13]=o[1],e[14]=o[2],e[15]=1,e}function E(e,t,o,n,r){let i,a=1/Math.tan(t/2);return e[0]=a/o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==Infinity?(i=1/(n-r),e[10]=(r+n)*i,e[14]=2*r*n*i):(e[10]=-1,e[14]=-2*n),e}function x(e,t,o,n,r,i,a){let s=1/(t-o),c=1/(n-r),m=1/(i-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*m,e[11]=0,e[12]=(t+o)*s,e[13]=(r+n)*c,e[14]=(a+i)*m,e[15]=1,e}function b(e,t,o,n){let r,i,a,s,c,m,l,d,_,f,p=t[0],u=t[1],y=t[2],v=n[0],h=n[1],E=n[2],x=o[0],b=o[1],R=o[2];return ge(p-x)<De&&ge(u-b)<De&&ge(y-R)<De?g(e):(l=p-x,d=u-b,_=y-R,f=1/Ee(l*l+d*d+_*_),l*=f,d*=f,_*=f,r=h*_-E*d,i=E*l-v*_,a=v*d-h*l,f=Ee(r*r+i*i+a*a),f?(f=1/f,r*=f,i*=f,a*=f):(r=0,i=0,a=0),s=d*a-_*i,c=_*r-l*a,m=l*i-d*r,f=Ee(s*s+c*c+m*m),f?(f=1/f,s*=f,c*=f,m*=f):(s=0,c=0,m=0),e[0]=r,e[1]=s,e[2]=l,e[3]=0,e[4]=i,e[5]=c,e[6]=d,e[7]=0,e[8]=a,e[9]=m,e[10]=_,e[11]=0,e[12]=-(r*p+i*u+a*y),e[13]=-(s*p+c*u+m*y),e[14]=-(l*p+d*u+_*y),e[15]=1,e)}function R(){let e=new Ue(9);return Ue!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function A(){let e=new Ue(4);return Ue!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function S(){let e=new Ue(4);return Ue!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function k(e,t,o){o*=0.5;let n=ue(o);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=pe(o),e}function F(e,t,o){let n=t[0],r=t[1],i=t[2],a=t[3],s=o[0],c=o[1],m=o[2],l=o[3];return e[0]=n*l+a*s+r*m-i*c,e[1]=r*l+a*c+i*s-n*m,e[2]=i*l+a*m+n*c-r*s,e[3]=a*l-n*s-r*c-i*m,e}function L(e,o,n,r){let t,i,a,s,c,m=o[0],l=o[1],d=o[2],_=o[3],f=n[0],p=n[1],u=n[2],g=n[3];return i=m*f+l*p+d*u+_*g,0>i&&(i=-i,f=-f,p=-p,u=-u,g=-g),1-i>De?(t=ve(i),a=ue(t),s=ue((1-r)*t)/a,c=ue(r*t)/a):(s=1-r,c=r),e[0]=s*m+c*f,e[1]=s*l+c*p,e[2]=s*d+c*u,e[3]=s*_+c*g,e}function T(e,t){let o,n=t[0]+t[4]+t[8];if(0<n)o=Ee(n+1),e[3]=0.5*o,o=0.5/o,e[0]=(t[5]-t[7])*o,e[1]=(t[6]-t[2])*o,e[2]=(t[1]-t[3])*o;else{let n=0;t[4]>t[0]&&(n=1),t[8]>t[3*n+n]&&(n=2);let r=(n+1)%3,i=(n+2)%3;o=Ee(t[3*n+n]-t[3*r+r]-t[3*i+i]+1),e[n]=0.5*o,o=0.5/o,e[3]=(t[3*r+i]-t[3*i+r])*o,e[r]=(t[3*r+n]+t[3*n+r])*o,e[i]=(t[3*i+n]+t[3*n+i])*o}return e}function O(e,t,o,n){const r=Float32Array.of(...t,...o,...n);return Ke(e,T(e,r))}function w(e){return e*he/180}function P(e){const t=Ze.createBuffer();return Ze.bindBuffer(Ze.ARRAY_BUFFER,t),Ze.bufferData(Ze.ARRAY_BUFFER,new Float32Array(e),Ze.STATIC_DRAW),t}function C(e){const t=Ze.createBuffer();return Ze.bindBuffer(Ze.ELEMENT_ARRAY_BUFFER,t),Ze.bufferData(Ze.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),Ze.STATIC_DRAW),t}function M(e,t){const o=Ze.createShader(e);if(Ze.shaderSource(o,t),Ze.compileShader(o),!Ze.getShaderParameter(o,Ze.COMPILE_STATUS))throw Ze.getShaderInfoLog(o);return o}function D(e,t){const o=Ze.createProgram();if(Ze.attachShader(o,e),Ze.attachShader(o,t),Ze.linkProgram(o),!Ze.getProgramParameter(o,Ze.LINK_STATUS))throw Ze.getProgramInfoLog(o);return o}function U(e){return`#version 300 es

    ${e.map((e)=>`
      #define ${e}
    `).join("")}

    precision mediump float;

    uniform vec4 c;

    in vec3 fp;

    #ifdef LIGHTS
      #define MAX_LIGHTS 100

      uniform vec3[MAX_LIGHTS] lp;
      uniform vec3[MAX_LIGHTS] lc;
      uniform float[MAX_LIGHTS] li;
      uniform int al;

      in vec3 fn;
    #endif

    #ifdef FOG
      uniform vec3 fog_color;
      uniform vec2 fog_distance;
      in float f_distance;
    #endif

    out vec4 frag_color;

    void main()
    {
      #ifdef FOG
        float fog_factor = clamp((fog_distance.y - f_distance) / (fog_distance.y - fog_distance.x), 0.0, 1.0);
      #endif

      #ifdef LIGHTS
          vec4 p_c = c;

          vec3 n = fn;

        vec4 light = vec4(0.0, 0.0, 0.0, 1.0);
        for (int i = 0; i < al; i++) {
          vec3 light_dir = lp[i] - fp;
          vec3 L = normalize(light_dir);
          float light_dist = length(light_dir);
          float diffuse_factor = max(dot(n, L), 0.0);
          vec3 rgb = p_c.rgb * diffuse_factor * lc[i] * li[i] / light_dist;
          light += vec4(rgb, p_c.a);
        }

        #ifdef FOG
          frag_color = mix(vec4(fog_color, 1.0), light, fog_factor);
        #else
          frag_color = light;
        #endif
      #else
          #ifdef FOG
            frag_color = mix(vec4(fog_color, 1.0), c, fog_factor);
          #else
            frag_color = c;
          #endif
      #endif
    }
  `}function B(e){return`#version 300 es

    ${e.map((e)=>`
      #define ${e}
    `).join("")}

    precision mediump float;

    uniform mat4 p;
    uniform mat4 v;
    uniform mat4 w;

    in vec3 P_current;

    #ifdef LIGHTS
      in vec3 N_current;
      out vec3 fn;
    #endif

    #ifdef FOG
      uniform vec3 camera;
      out float f_distance;
    #endif

    out vec3 fp;

    void main()
    {

        fp = (w * vec4(P_current, 1.0)).xyz;

        #ifdef LIGHTS
          fn = (vec4(N_current, 0.0)).xyz;
        #endif

      gl_Position = p * v * vec4(fp, 1.0);

      #ifdef FOG
        f_distance = distance(w * vec4(P_current, 1.0), vec4(camera, 1.0));
      #endif
    }
  `}function I(e=0,t=1){return fe(yt()*(t-e+1)+e)}function j(e=0,t=1){return yt()*(t-e)+e}function N(e){return e[I(0,e.length-1)]}function H(e){return new Qe({components:[new nt({position:e})]})}function q({position:e,scale:t}){let o=new Ht;return o.components.get(it).set({material:Jt,color:bt,tag:Yt}),o.components.get(nt).set({position:e,scale:t}),o}function G({position:e,color:t,intensity:o}){return new Qe({components:[new nt({position:e}),new ht({color:t,intensity:o})]})}function Y({position:e,scale:t,color:o,is_north_south:n,is_negative:r}){let i=H(e),a=new Ht;a.components.get(it).set({material:Jt,color:o,tag:zt}),a.components.get(nt).set({scale:t}),i.add(a);let s=G({position:[n?0:r*At,0,n?r*At:0],color:o,intensity:St});return i.add(s),i}function z({position:e,scale:t,neons:o}){let n=H(e),r=new Ht;r.components.get(it).set({material:Jt,color:bt,tag:Yt}),r.components.get(nt).set({scale:t}),n.add(r);for(let r of o){let e=Y(r);n.add(e)}return n}function K(e){let t=new Ht;return t.components.get(it).set({material:Wt,color:Ft}),t.components.get(nt).set(e),t.add_component(new Dt({radius:0.6,action:[Me]})),t.add_component(new qt({speed:[0,0.0001,0]})),t}function W({system:e,position:t}){let o=new Ht;o.components.get(it).set({material:Jt,color:Ft,tag:Kt}),o.components.get(nt).set({position:t}),o.add_component(new Dt({radius:1,action:[Ce,e]})),o.add_component(new qt({speed:[0.0001,0.0002,0.0003]}));let n=new Qe({components:[new nt,new lt({color:Ft,intensity:Lt})]});return o.add(n),o}function X(){const e=new ft({width:window.innerWidth,height:window.innerHeight,far:126,clear_color:xt});e.buildings=[],e.perspe_matrix=JSON.parse(JSON.stringify(e.projMatrix)),e.setup_ortho_camera(),e.canvas.addEventListener("click",()=>document.body.requestPointerLock()),e.camera.components.get(nt).set({position:[Zt.start[0]*Et,1.75,Zt.start[1]*Et]}),e.camera.remove_component(ct);const t=new vt;e.camera.add_component(t),t.set({keyboard_controlled:!0,mouse_controlled:!1,move_speed:5,rotate_speed:0}),e.camera.add_component(new Ut),e.camera.add_component(new Mt),e.remove(e.light);let o=q({position:[0,-0.5,0],scale:[10*(Zt.size[0]*Et),1,10*(Zt.size[1]*Et)]});e.add(o);for(let[t,o,n,r,i]of Zt.buildings){let a=ge(n-t)*Et,s=ge(r-o)*Et,c=t*Et+a/2,m=o*Et+s/2,l=i*Et,d=z({position:[c,l/2,m],scale:[a,l,s],neons:Array(I(2,4)).fill(0).map((e,t,o)=>{const n=N([!0,!1]),r=N([1,-1]),i=l*kt/(o.length+0.5);return{position:[n?0:r*(a/2)+0.2*r,l/2-(i+0.5)*(t+1),n?r*(s/2)+0.2*r:0],scale:[n?a*kt:0.1,i,n?0.1:s*kt],color:bt,is_north_south:n,is_negative:r}})});e.add(d),e.buildings.push([c-a/2,c+a/2,m-s/2,m+s/2])}for(let[t,o,n]of Zt.items)e.add(W({system:Oe[t],position:[o*Et,1.75,n*Et]}));return window.game=e,e}function J(e){e.add(K({position:[Zt.end[0]*Et,50*Et/2,Zt.end[1]*Et],scale:[5*Et,200,5*Et]}))}function Z(e){e.stop(),e.destroy(),e.canvas.remove()}function $(){let e=j(Ot,wt);return t(o(0<e?e+1:e,Pt,Ct))}function Q(e,t){switch(t){case Ae:for(let t of e.components.get(it))switch(t.tag){case Yt:t.material=Xt,t.color=Rt;continue;case zt:t.material=Vt;continue;case Kt:t.material=Wt;}break;case Se:for(let t of e.components.get(it))switch(t.tag){case zt:{let e=$();t.set({color:e});for(let o of t.entity.parent.iterall(ht))o.set({color:e})}}break;case Le:e.camera.components.get(vt).set({mouse_controlled:!0,rotate_speed:.5});break;default:}}function ee(e){return[...e].map((e)=>e.codePointAt(0)).reduce((e,t)=>e+t,0)}function te(e,t,o){return ye(o,Math.max(t,e))}function oe(e,t,o,n,r){return n+(r-n)*((e-t)/(o-t))}function ne(e){let t=ee(e)%20;return oo`
        <div class="g">
            <div class="g1 n${t}">${e}</div>
            <div class="g2 n${t}">${e}</div>
            <div class="g3 n${t}">${e}</div>
        </div>
    `}function re(e,t){for(let o of e.querySelectorAll(".g > div"))o.innerHTML=t}function ie(e){return oo`
        <div class="l">
            ${ne(e)}
        </div>
    `}function ae(e){return new class extends xe{before(e){clearInterval(this.interval),e.removeEventListener("click",this.onclick)}after(t){let o=document.createElement("div"),n=e.split("\n")[Symbol.iterator](),r=t.querySelector(".t"),i=()=>{let e=n.next();e.done?clearInterval(this.interval):(o.innerHTML=ie(e.value),r.appendChild(o.firstElementChild))};this.onclick=()=>{this.before(t),this.interval=setInterval(i,100)},this.interval=setInterval(i,1e3),t.addEventListener("click",this.onclick)}render(){return oo`
                <div class="m s">
                    <div class="t" digest="${ee(e)}"></div>
                </div>
            `}}}function se(e,t=[],{align:o="stretch",justify:n="stretch",cls:r=""}={}){return oo`
        <div class="b ${e} ${r}"
            style="grid-area: ${e}; align-self: ${o}; justify-self: ${n};">
            ${t.map(ie)}
        </div>
    `}function ce(e){let t=[];for(let[o,n]of Object.entries(e)){let e=n?"Online":"Offline";t.push(`${o} = ${e}`)}return t}function me(e,t,o){return se(e,["Running analysis",...ce(o),"<div class=e>Assessment complete</div>"],t)}function le(e,t){return new class extends xe{before(){clearInterval(this.interval)}after(t){let o=document.createElement("div"),n=t.querySelector(`.${e}`);this.interval=setInterval(()=>{n.removeChild(n.firstElementChild),o.innerHTML=ie(io.next().value),n.appendChild(o.firstElementChild)},1e3)}render(){return se(e,Array(10).fill(""),t)}}}function de(e,t){return new class extends xe{before(){clearInterval(this.interval)}after(t){let o=t.querySelectorAll(`.${e} .l`);this.interval=setInterval(()=>{let e=new Date;for(let[t,n]of o.entries())n.innerHTML=ne(ao[t].format(e))},1e3)}render(){let o=new Date;return se(e,[ao[0].format(o),ao[1].format(o)],t)}}}function _e(e,t){return new class extends xe{constructor(){super(),this.nf=new Intl.NumberFormat("en",{minimumFractionDigits:3,maximumFractionDigits:3})}before(){game.off("afterrender",this.up)}after(t){let o=Array.from(t.querySelectorAll(`.${e} .l`)).slice(1);this.up=game.on("afterrender",()=>{let e=game.camera.components.get(nt).matrix,t=[[e[0],e[4],e[8],e[12]],[e[1],e[5],e[9],e[13]],[e[2],e[6],e[10],e[14]],[e[3],e[7],e[11],e[15]]];for(let[e,n]of o.entries())re(n,t[e].map((e)=>this.nf.format(e)).join(" "))})}render(){return se(e,["Avatar entity matrix","1","2","3","4"],t)}}}var fe=Math.floor,pe=Math.cos,ue=Math.sin,ge=Math.abs,ye=Math.min,ve=Math.acos,he=Math.PI,Ee=Math.sqrt;class xe{before(){}render(){}after(){}}const be="Heads-Up Display",Re="Perspective",Ae="Light Sensor",Se="Chromatic Sampling",ke="Low-Res Timer",Fe="Compass",Le="Gimbal Mount",Te="WASD Movement";var Oe=Object.freeze({HUD:be,PERSPECTIVE:Re,SOLID:Ae,COLOR:Se,CLOCK:ke,COMPASS:Fe,MOUSELOOK:Le,GRID:Te});const we=0,Pe=1,Ce=2,Me=3,De=1e-6;let Ue="undefined"==typeof Float32Array?Array:Float32Array;const Be=function(e){let t=e[0],o=e[1],n=e[2];return Ee(t*t+o*o+n*n)},Ie=function(){let e=n();return function(t,o,n,r,a,s){let c,i;for(o||(o=3),n||(n=0),i=r?ye(r*o+n,t.length):t.length,c=n;c<i;c+=o)e[0]=t[c],e[1]=t[c+1],e[2]=t[c+2],a(e,e,s),t[c]=e[0],t[c+1]=e[1],t[c+2]=e[2];return t}}(),je=Float32Array,V=je.of(0,0,0),Ne=je.of(1,1,1),He=je.of(1,0,0),qe=je.of(0,1,0),Ge=je.of(0,0,1),Ye=(...e)=>je.of(...e),ze=function(){let e=A();return function(t,o,n,r,a,s){let c,i;for(o||(o=4),n||(n=0),i=r?ye(r*o+n,t.length):t.length,c=n;c<i;c+=o)e[0]=t[c],e[1]=t[c+1],e[2]=t[c+2],e[3]=t[c+3],a(e,e,s),t[c]=e[0],t[c+1]=e[1],t[c+2]=e[2],t[c+3]=e[3];return t}}(),Ke=function(e,t){let o=t[0],n=t[1],r=t[2],i=t[3],a=o*o+n*n+r*r+i*i;return 0<a&&(a=1/Ee(a),e[0]=o*a,e[1]=n*a,e[2]=r*a,e[3]=i*a),e},Ve=function(){let e=n(),t=r(1,0,0),o=r(0,1,0);return function(n,r,i){let a=l(r,i);return-0.999999>a?(d(e,t,r),1e-6>Be(e)&&d(e,o,r),m(e,e),k(n,e,Math.PI),n):0.999999<a?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(d(e,r,i),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=1+a,Ke(n,n))}}(),We=function(){let e=S(),o=S();return function(n,r,i,a,s,c){return L(e,r,s,c),L(o,i,a,c),L(n,e,o,2*c*(1-c)),n}}(),Xe=function(){let e=R();return function(t,o,n,r){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=r[0],e[4]=r[1],e[7]=r[2],e[2]=-o[0],e[5]=-o[1],e[8]=-o[2],Ke(t,T(t,e))}}(),Je=document.createElement("canvas"),Ze=Je.getContext("webgl2"),$e={components:[],skip:!1};class Qe{constructor(e={}){Object.assign(this,$e,e),this.entities=new Set,this.components=new Map;for(let t of e.components)this.add_component(t)}add_component(e){e.entity=this,e.mount(),this.components.set(e.constructor,e),this.game&&(!this.game.components.has(e.constructor)&&this.game.components.set(e.constructor,new Set),this.game.components.get(e.constructor).add(e))}remove_component(e){let t=this.components.get(e);this.components.delete(e),this.game&&this.game.components.has(e)&&this.game.components.get(e).delete(t)}*iterall(e){for(let t of this.entities)t.components.has(e)&&(yield t.components.get(e)),yield*t.iterall(e)}add(e){e.parent=this,this.entities.add(e),this.game&&this.game.track_entity(e)}update(e){if(!this.skip){const t=(t)=>t.update(e);this.components.forEach(t),this.entities.forEach(t)}}render(e){if(!this.skip){const t=(t)=>t.render(e);this.components.forEach(t),this.entities.forEach(t)}}}const et={entity:null};class tt{constructor(e){Object.assign(this,et,e)}static get features(){return[]}mount(){}set(e){Object.assign(this,e)}update(){}render(){}}const ot={_scale:Ne.slice(),_rotation:S(),scale:Ne.slice(),position:V.slice(),rotation:S()};class nt extends tt{constructor(e){super(Object.assign({matrix:p(),world_matrix:p(),world_to_self:p()},ot,e))}get left(){const e=this.matrix.slice(0,3);return m(e,e)}get up(){const e=this.matrix.slice(4,7);return m(e,e)}get forward(){const e=this.matrix.slice(8,11);return m(e,e)}set position(e){h(this.matrix,this.rotation,e,this.scale)}get position(){return this.matrix.slice(12,15)}set scale(e){this._scale=e,h(this.matrix,this.rotation,this.position,e)}get scale(){return this._scale}set rotation(e){this._rotation=e,h(this.matrix,e,this.position,this.scale)}get rotation(){return this._rotation}look_at(e){const t=V.slice();a(t,e,this.position),m(t,t);const o=Ye(t[2],0,-t[0]);m(o,o);const n=V.slice();d(n,t,o);const r=S();O(r,o,n,t),this.rotation=r}rotate_along(e,t){const o=S();k(o,e,t),F(o,this.rotation,o),this.rotation=o}rotate_rl(e){this.rotate_along(qe,e)}rotate_ud(e){this.rotate_along(He,e)}translate(e){const t=V.slice();i(t,this.position,e),this.position=t}get_view_matrix(e){const t=[];return i(t,this.position,this.forward),b(e,this.position,t,this.up),e}update(){this.entity.parent?v(this.world_matrix,this.entity.parent.components.get(nt).world_matrix,this.matrix):this.world_matrix=this.matrix.slice(),y(this.world_to_self,this.world_matrix)}}const rt={material:null,vertices:[],indices:[],normals:[],uvs:[],color:"fff",opacity:1};class it extends tt{constructor(e){super(e),Object.assign(this,rt,e),this.create_buffers()}set color(t){this._color=t||"fff",this.color_vec=[...e(this._color),this.opacity]}get color(){return this._color}create_buffers(){this.buffers={vertices:P(this.vertices),indices:C(this.indices),qty:this.indices.length,normals:P(this.normals),uvs:P(this.uvs)}}render(){this.material.render(this.entity)}}const at=3,st={keyboard_controlled:!1,mouse_controlled:!1,move_speed:3.5,rotate_speed:.5,dir_desc:{37:"yl",38:"pu",39:"yr",40:"pd",65:"l",68:"r",69:"u",81:"d",83:"b",87:"f"}};class ct extends tt{constructor(e){super(e),Object.assign(this,st,e)}handle_keys(e,{f:t=0,b:o=0,l:n=0,r:i=0,u:r=0,d:c=0,pu:l=0,pd:d=0,yl:f=0,yr:p=0}){const u=this.entity.components.get(nt),g=e/1e3*this.move_speed,y=Ye(n-i,0,t-o);_(y,y,u.matrix),a(y,y,u.position),y[1]=r-c,m(y,y),s(y,y,g),u.translate(y);this.handle_mouse(e,{x:f*at-p*at,y:l*at-d*at})}handle_mouse(e,{x:t,y:o}){const n=this.entity.components.get(nt);if(0!==t||0!==o){const r=e/1e3,i=this.rotate_speed*r*t,a=this.rotate_speed*r*o,s=Ye(pe(a)*ue(i),ue(a),pe(a)*pe(i));m(s,s),_(s,s,n.matrix),n.look_at(s)}}update(e){if(this.keyboard_controlled&&this.entity.game){const t={};for(const[e,o]of Object.entries(this.dir_desc))t[o]=this.entity.game.get_key(e);this.handle_keys(e,t)}this.mouse_controlled&&this.entity.game&&this.handle_mouse(e,this.entity.game.mouse_delta)}}const mt={intensity:0.5,color:"#ffffff"};class lt extends tt{constructor(e){super(Object.assign(mt,e))}set color(t){this._color=t||"fff",this.color_vec=[...e(this._color)]}get color(){return this._color}}const dt={canvas:Je,width:800,height:600,dom:document.body,fps:60,running:!0,fov:60,near:0.35,far:85,left:-10,right:10,bottom:-10,top:10,clear_color:"#FFFFFF",clear_opacity:1,projection:"perspective"},_t=["keydown","keyup","mousemove"];class ft{constructor(e){Object.assign(this,dt,e),this.canvas.width=this.width,this.canvas.height=this.height,this.dom.appendChild(Je),this.reset(),this.camera=new Qe({components:[new nt,new ct]}),this.camera.game=this,this.light=new Qe({components:[new nt,new lt]}),this.add(this.light),this.projMatrix=p(),this.viewMatrix=p(),"ortho"===this.projection?this.setup_ortho_camera():this.setup_perspective_camera(),this.tick_delta=1e3/this.fps;for(const t of _t){const e="on"+t;this[e]=this[e].bind(this),window.addEventListener(t,this[e])}this.running&&this.start(),Ze.enable(Ze.CULL_FACE),Ze.enable(Ze.DEPTH_TEST),Ze.clear(Ze.DEPTH_BUFFER_BIT|Ze.COLOR_BUFFER_BIT)}setup_ortho_camera(){x(this.projMatrix,this.left,this.right,this.bottom,this.top,this.near,this.far)}setup_perspective_camera(){E(this.projMatrix,w(this.fov),this.width/this.height,this.near,this.far)}get clear_color(){return this._clear_color}set clear_color(t){this._clear_color=t;const o=e(t);Ze.clearColor(o[0],o[1],o[2],this.clear_opacity)}set clear_opacity(t){this._clear_opacity=t;const o=e(this._clear_color);Ze.clearColor(o[0],o[1],o[2],this._clear_opacity)}get clear_opacity(){return this._clear_opacity}stop(){this.running=!1}start(){this.running=!0,this.last_tick=performance.now(),window.requestAnimationFrame((e)=>this.frame(e))}reset(){this.entities=new Set,this.listeners=new Map,this.keys={},this.mouse_delta={x:0,y:0},this.components=new WeakMap}destroy(){for(const e of _t)window.removeEventListener(e,this[e])}emit(e,...t){if(this.listeners.has(e))for(const o of this.listeners.get(e))o(...t)}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),t}off(e,t){this.listeners.has(e)&&this.listeners.get(e).delete(t)}onkeydown(t){this.keys[t.keyCode]=1}onkeyup(t){this.keys[t.keyCode]=0}get_key(e){return this.keys[e]||0}onmousemove(t){this.mouse_delta.x-=t.movementX,this.mouse_delta.y-=t.movementY}frame(e){if(this.running&&window.requestAnimationFrame((e)=>this.frame(e)),e>this.last_tick+this.tick_delta){const t=e-this.last_tick,o=fe(t/this.tick_delta);this.perform_ticks(o),this.render()}}perform_ticks(e){this.mouse_delta.x/=e,this.mouse_delta.y/=e;for(let t=0;t<e;t++)this.last_tick+=this.tick_delta,this.update();this.mouse_delta.x=0,this.mouse_delta.y=0}update(){this.emit("tick",this.last_tick),this.entities.forEach((e)=>e.update(this.tick_delta)),this.camera.update(this.tick_delta),this.camera.components.get(nt).get_view_matrix(this.viewMatrix)}render(){Ze.clear(Ze.COLOR_BUFFER_BIT|Ze.DEPTH_BUFFER_BIT),Ze.viewport(0,0,this.canvas.width,this.canvas.height),this.entities.forEach((e)=>e.render()),this.emit("afterrender")}track_entity(e){e.game=this;for(let t of e.components.values())this.components.has(t.constructor)||this.components.set(t.constructor,new Set),this.components.get(t.constructor).add(t);for(let t of e.entities)this.track_entity(t)}untrack_entity(e){e.game=null;for(let t of e.components.values())this.components.get(t.constructor).delete(t);for(let t of e.entities)this.untrack_entity(t)}add(e){this.entities.add(e),this.track_entity(e)}remove(e){this.entities.delete(e),this.untrack_entity(e)}}class pt{constructor(e){this.to=e.to,this.time=e.time||1e3,this.game=e.game,this.object=e.object,this.property=e.property,this.cb=e.cb}do_step(e){this.current_step=ye(1,(e-this.first_tick)/this.tick_delta*this.step),this.action()}action(){}pre_start(){this.tick_delta=this.game.tick_delta,this.first_tick=this.game.last_tick,this.number_of_ticks=Math.ceil(this.time/this.tick_delta),this.step=1/this.number_of_ticks}start(){return this.pre_start(),new Promise((e)=>{const t=(o)=>{1===this.current_step?(this.game.off("tick",t),e()):this.do_step(o,e)};this.game.on("tick",t)})}}class ut{constructor(e={}){this.uniforms={},this.attribs={},this.draw_mode=Ze.TRIANGLES,this.features=new Set([].concat(...Array.from(e.requires||[]).map((e)=>e.features))),this._textures={},this.texture=e.texture||!1,this.normal_map=e.normal_map||!1}add_feature(e){this.features.add(e)}has_feature(e){return this.features.has(e)}remove_feature(e){this.features.delete(e)}add_fog(e={}){this.add_feature("FOG"),this.fog={color:e.color||new Float32Array([0,0,0]),distance:e.distance||new Float32Array([10,30])},this.setup_program()}setup_program(){return this.program=D(M(Ze.VERTEX_SHADER,B(Array.from(this.features))),M(Ze.FRAGMENT_SHADER,U(Array.from(this.features)))),this.program.error?void console.log(this.program.error):void this.get_locations()}get_uniforms_and_attrs(e,t){e.forEach((e)=>{this.uniforms[e]=Ze.getUniformLocation(this.program,e)}),t.forEach((e)=>{this.attribs[e]=Ze.getAttribLocation(this.program,e)})}set texture(e){this.build_texture(e,this._texture_image,"TEXTURE","gl_texture")}get texture(){return this._texture_image}set normal_map(e){this.build_texture(e,this._normal_map_image,"NORMAL_MAP","gl_normal_map")}get normal_map(){return this._normal_map_image}build_texture(e,t,o,n){e?(!this._textures[n]&&(this._textures[n]=Ze.createTexture()),e.then((e)=>{t!==e&&(t=e,Ze.bindTexture(Ze.TEXTURE_2D,this._textures[n]),Ze.texImage2D(Ze.TEXTURE_2D,0,Ze.RGBA,Ze.RGBA,Ze.UNSIGNED_BYTE,e),Ze.generateMipmap(Ze.TEXTURE_2D),!this.has_feature(o)&&(this.add_feature(o),this.setup_program()))}).catch(console.error)):!e&&(t=null,this.remove_feature(o),this.setup_program())}render(e){let t=e,o=t.game;for(;t.parent&&!o;)t=t.parent,o=t.game;Ze.useProgram(this.program),Ze.uniformMatrix4fv(this.uniforms.p,Ze.FALSE,o.projMatrix),Ze.uniformMatrix4fv(this.uniforms.v,Ze.FALSE,o.viewMatrix),Ze.uniformMatrix4fv(this.uniforms.w,Ze.FALSE,e.components.get(nt).world_matrix),Ze.uniform4fv(this.uniforms.c,e.components.get(it).color_vec),this.apply_shader(e,o)}}let gt=132079672568928;const yt=function(){return gt=16807*gt%2147483647,(gt-1)/2147483646};class vt extends ct{constructor(){super(),delete this.dir_desc[69],delete this.dir_desc[81],this.tick=0,this.size=0.5}mount(){this.transform=this.entity.components.get(nt),this.buildings=window.bul=this.entity.game.buildings,this.last_position=this.transform.position}is_colliding(){const{position:e}=this.transform;return this.buildings.some((t)=>e[0]+this.size>=t[0]&&e[0]-this.size<=t[1]&&e[2]+this.size>=t[2]&&e[2]-this.size<=t[3])}update(e){this.tick++,this.is_colliding()?this.transform.position=this.last_position:(0==this.tick%10&&(this.last_position=this.transform.position),super.update(e))}}class ht extends tt{set(e){super.set(e),this.active&&this.entity.components.get(lt).set(e)}on(){this.active=!0;let{color:e,intensity:t}=this;this.entity.add_component(new lt({color:e,intensity:t}))}off(){this.active=!1,this.entity.remove_component(lt)}}const Et=4,xt="333",bt="888",Rt="222",At=2,St=10,kt=0.8,Ft="fff",Lt=5,Tt=30,Ot=-.09,wt=.55,Pt=.9,Ct=.6;class Mt extends tt{update(){let e=this.entity.components.get(nt),t=e.world_matrix.slice(12,15),o=this.entity.game.components.get(ht);for(let e of o){let o=e.entity.components.get(nt),n=o.world_matrix.slice(12,15),r=c(t,n);if(r>Tt&&e.active){e.off();continue}r<=Tt&&!e.active&&e.on()}}}class Dt extends tt{mount(){this.transform=this.entity.components.get(nt)}contains(e){let t=V.slice();return _(t,e,this.transform.world_to_self),t.map(Math.abs).every((e)=>e<=this.radius)}trigger(){this.entity.game.remove(this.entity),dispatch(...this.action)}}class Ut extends tt{mount(){this.transform=this.entity.components.get(nt)}update(){let e=this.entity.game.components.get(Dt);for(let t of e)t.contains(this.transform.position)&&t.trigger()}}const Bt=[0.5,0.5,0.5,0.5,0.5,-0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,-0.5,-0.5,0.5,-0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,0.5,0.5,-0.5,-0.5,0.5,-0.5,0.5,-0.5,-0.5,-0.5,-0.5,-0.5],It=[0,2,1,2,3,1,4,6,5,6,7,5,8,10,9,10,11,9,12,14,13,14,15,13,16,18,17,18,19,17,20,22,21,22,23,21],jt=[1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1],Nt=[0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1];class Ht extends Qe{constructor(e={}){e.components=[new nt,new it({vertices:Bt,indices:It,normals:jt,material:e.material,uvs:Nt})],super(e)}}class qt extends tt{mount(){this.transform=this.entity.components.get(nt)}update(e){let[t,o,n]=this.speed;this.transform.rotate_along(He,t*e),this.transform.rotate_along(qe,o*e),this.transform.rotate_along(Ge,n*e)}}class Gt extends ut{constructor(e){super(e),this.setup_program()}get_locations(){this.get_uniforms_and_attrs(["p","v","w","c","frame_delta","fog_color","fog_distance","camera"],["P_current","P_next","a_t"])}apply_shader(e,t){const o=e.components.get(it);let n=o.buffers;o.material.has_feature("FOG")&&(Ze.uniform3fv(this.uniforms.fog_color,this.fog.color),Ze.uniform2fv(this.uniforms.fog_distance,this.fog.distance),Ze.uniform3fv(this.uniforms.camera,t.camera.components.get(nt).position)),Ze.bindBuffer(Ze.ARRAY_BUFFER,n.vertices),Ze.vertexAttribPointer(this.attribs.P_current,3,Ze.FLOAT,Ze.FALSE,0,0),Ze.enableVertexAttribArray(this.attribs.P_current),Ze.bindBuffer(Ze.ELEMENT_ARRAY_BUFFER,n.indices),Ze.drawElements(this.draw_mode,n.qty,Ze.UNSIGNED_SHORT,0)}}const Yt=1,zt=2,Kt=3;let Vt=new Gt;Vt.add_fog({color:e(xt),distance:new Float32Array([25,100])});let Wt=new Gt,Xt=new class extends ut{constructor(e){super(e),this.add_feature("LIGHTS"),this.setup_program()}get_locations(){this.get_uniforms_and_attrs(["p","v","w","lp","li","lc","al","c","u_t","n_m","frame_delta","fog_color","fog_distance","camera"],["P_current","P_next","N_current","N_next","a_t"])}apply_shader(e,t){const o=e.components.get(it);let n=o.buffers;o.material.has_feature("FOG")&&(Ze.uniform3fv(this.uniforms.fog_color,this.fog.color),Ze.uniform2fv(this.uniforms.fog_distance,this.fog.distance),Ze.uniform3fv(this.uniforms.camera,t.camera.components.get(nt).position)),Ze.bindBuffer(Ze.ARRAY_BUFFER,n.vertices),Ze.vertexAttribPointer(this.attribs.P_current,3,Ze.FLOAT,Ze.FALSE,0,0),Ze.enableVertexAttribArray(this.attribs.P_current),Ze.bindBuffer(Ze.ARRAY_BUFFER,n.normals),Ze.vertexAttribPointer(this.attribs.N_current,3,Ze.FLOAT,Ze.FALSE,0,0),Ze.enableVertexAttribArray(this.attribs.N_current),Ze.bindBuffer(Ze.ELEMENT_ARRAY_BUFFER,n.indices),Ze.drawElements(this.draw_mode,n.qty,Ze.UNSIGNED_SHORT,0);const r=Array.from(t.components.get(lt)),a=r.length;let s=new Float32Array(3*a),c=new Float32Array(3*a),m=new Float32Array(a);for(let o=0;o<a;o++){let e=r[o].entity.components.get(nt),t=e.world_matrix.slice(12,15);s.set(t,3*o),c.set(r[o].color_vec,3*o),m[o]=r[o].intensity}Ze.uniform1i(this.uniforms.al,a),Ze.uniform3fv(this.uniforms.lp,s),Ze.uniform3fv(this.uniforms.lc,c),Ze.uniform1fv(this.uniforms.li,m)}};Xt.add_fog({color:e(xt),distance:new Float32Array([0,40])});let Jt=new class extends Gt{constructor(e){super(e),this.draw_mode=Ze.LINE_STRIP}};var Zt={size:[63,63],buildings:[[56,0,63,4,26],[46,0,54,3,37],[25,0,32,2,35],[17,0,23,6,39],[8,0,13,3,35],[0,0,8,12,30],[24,3,32,8,8],[35,4,42,7,32],[32,4,35,7,21],[60,5,63,13,23],[58,5,60,10,16],[46,5,58,8,6],[8,5,12,13,4],[42,6,46,11,8],[35,7,39,9,17],[21,8,27,12,7],[12,8,21,11,21],[48,12,54,18,28],[16,12,18,15,4],[0,12,5,16,13],[57,13,63,16,6],[44,13,46,20,18],[33,13,37,17,8],[11,13,14,16,16],[8,13,11,16,20],[42,14,44,17,15],[24,14,31,16,18],[60,16,63,24,32],[16,16,22,18,6],[11,16,14,19,12],[8,16,11,19,24],[0,16,4,24,21],[28,17,30,20,4],[24,17,27,23,8],[34,19,36,20,3],[17,19,22,21,3],[51,20,54,25,18],[37,20,40,23,3],[33,20,36,23,4],[50,21,51,22,17],[46,21,48,24,3],[43,21,46,27,5],[28,21,31,28,3],[17,21,22,24,18],[11,21,15,24,9],[4,21,9,27,3],[56,22,60,27,8],[39,24,40,26,2],[37,24,39,29,3],[33,24,35,27,4],[24,24,28,28,11],[19,25,22,30,5],[60,26,63,31,26],[0,26,3,34,34],[51,27,54,30,17],[48,27,51,30,6],[4,27,6,33,15],[41,28,46,32,14],[33,28,36,31,5],[57,29,60,40,9],[25,29,29,32,2],[24,29,25,31,1],[48,30,54,33,20],[19,30,22,31,3],[6,31,10,34,4],[61,33,63,38,29],[21,33,23,40,13],[33,34,36,39,21],[28,34,31,39,17],[17,34,20,37,8],[8,34,13,38,10],[48,35,52,40,13],[44,35,47,44,20],[36,35,41,38,13],[24,35,27,40,3],[15,35,17,38,5],[0,36,8,39,28],[3,39,6,47,21],[54,40,63,43,20],[33,40,39,45,30],[24,40,31,43,5],[16,40,19,42,7],[10,40,14,44,14],[47,41,51,44,15],[16,42,22,44,11],[55,43,63,46,11],[25,44,30,46,8],[52,46,56,52,5],[17,46,21,48,8],[9,46,13,58,10],[58,47,63,54,35],[45,47,50,52,31],[0,47,9,51,3],[34,49,41,52,5],[24,50,29,57,16],[15,50,18,54,28],[20,51,24,54,19],[53,52,56,55,19],[34,52,43,55,23],[0,53,7,63,35],[44,54,53,58,9],[31,55,44,58,17],[57,56,63,63,28],[23,57,31,63,41],[9,58,23,61,17],[46,59,54,63,36],[34,60,42,63,38]],start:[33,18],end:[14,29],items:[["SOLID",47,25],["COLOR",38,39],["COMPASS",37,30],["CLOCK",23,41],["MOUSELOOK",32,26]]};const $t={view:"intro",systems:{[be]:!1,[Re]:!1,[Ae]:!1,[Se]:!1,[ke]:!1,[Fe]:!1,[Le]:!1,[Te]:!0}},{attach:Qt,connect:eo,dispatch:to,html:oo}=function(e){function t(e){if(e instanceof xe){let t=e.render();return"BEFORE"===n?e.before(r):"AFTER"===n?e.after(r):t}return e}function o(e){let o=a;n="BEFORE",a=o,t(i()),n="RENDER",a=e,r.innerHTML=t(i()),n="AFTER",a=e,t(i())}let n,r,i,a=e();return{attach(e,t){r=t,i=e,o(a)},connect(e){return(...t)=>e(a,...t)},dispatch(t,...n){let r=e(a,t,n);o(r)},html([e,...o],...n){return n.reduce((e,n)=>e.concat(t(n),o.shift()),[e]).filter((e)=>e&&!0!==e||0===e).join("")}}}(function(e=$t,t,o){switch(t){case we:return Object.assign({},e,{view:"diag"});case Pe:return document.body.requestPointerLock(),Object.assign({},e,{view:"play",game:X(),last:be,systems:Object.assign({},e.systems,{[be]:!0})});case Ce:{let[t]=o;Q(game,t);let n=[...Object.values(e.systems)],r=n.filter((e)=>e);return 1==n.length-r.length&&J(game),Object.assign({},e,{last:t,systems:Object.assign({},e.systems,{[t]:!0})})}case Me:return document.exitPointerLock(),Z(e.game),Object.assign({},e,{view:"outro"});default:return e;}}),no=`
<div class="h">LOGOUT</div>

In 2018, people live their lives in virtual reality.
Most never leave the community clusters assigned
to them at birth. A handful of lucky ones migrate
to premium clusters which boast 100% uptime.

You are not one of the lucky ones.

The community VR cluster you've spent your life in
has had a critical failure. The reboot has reset
the entire world.

Find the exit and log out into the reality.

<button onclick="dispatch(${we});event.stopPropagation()">Run system diagnostic</button>
`,ro=`\
Initiating logout sequence…

Reticulating splines…
Stopping services…
Clearing caches…

Logout complete

<a href="https://twitter.com/hashtag/js13k">Enter the real world</a>
`;var io=function*(){for(let e=U.toString().split("\n").slice(7,-2).map((e)=>e.trim()).filter(Boolean),t=0;;)yield e[t++%e.length]}();const ao=[new Intl.DateTimeFormat("en",{weekday:"short",month:"short",day:"2-digit",year:"numeric"}),new Intl.DateTimeFormat("en",{hour:"2-digit",minute:"2-digit",second:"2-digit"})];let so="NW ---- N ---- NE ---- E ---- SE ---- S ---- SW ---- W ---- ",co=so.length;so=so+so+so;let mo=18;var lo=eo(function({game:e},t,o){let n=w(e.fov/2);return new class extends xe{before(){e.off("afterrender",this.up)}after(o){let r=o.querySelector(`.${t} > :first-child`),i=o.querySelector(`.${t} > :last-child`);this.up=e.on("afterrender",()=>{var t=Math.round;let o=e.camera.components.get(nt),s=o.forward,c=0<s[0]?-1:1,l=t(f([0,0,1],s)/(2*he/co))*c,d=(so+so+so).slice(co+l,co+l+mo);re(r,d);let _=Array(mo).fill(0);for(let r of e.components.get(Dt)){let e=r.entity.components.get(nt).position;e[1]=1.75;let i=V.slice();a(i,e,o.position),m(i,i);let s=f(o.forward,i);s=te(s,0,n),s*=Math.sign(f(o.left,i)-he/2);let c=t(oe(s,-n,n,0,mo-1));_[c]++}re(i,_.map((e)=>0<e?"^":"&nbsp;").join(""))})}render(){return se(t,["Compass","Radar"],o)}}});class _o extends pt{action(){for(let e=0;e<this.from.length;e++)this.object[e]=this.from[e]+this.current_step*(this.to[e]-this.from[e])}pre_start(){super.pre_start(),this.from=u(this.object)}}var fo=eo(function({game:e,last:t,systems:o}){return new class extends xe{after(){t===be&&(setTimeout(()=>new _o({object:e.projMatrix,to:e.perspe_matrix,time:3e3,game:e}).start(),5e3),setTimeout(()=>dispatch(Ce,Re),7e3))}render(){return oo`
                <div class="m u">
                    ${o[be]&&me("tl",{},o)}

                    ${o[Fe]&&lo("tm",{justify:"center"})}

                    ${o[ke]&&de("tr",{justify:"end"})}

                    ${se("mm",[t,"<div class='h e'>Activated</div>"],{align:"center",justify:"center",cls:"f"})}

                    ${o[be]&&se("mr",["Active objectives","> 01. Bring Systems Online","> 02. Locate exit","> 03. Init logout sequence"])}

                    ${o[Re]&&_e("bl",{align:"end"})}

                    ${o[Ae]&&le("br",{align:"end"})}
                </div>
            `}}}),po=eo(function({view:e,systems:t}){switch(e){case"intro":return ae(no);case"diag":{let e=ce(t),o=e.pop(),n=["Running analysis\u2026\n",...e,`\n${o}`,`\n<button onclick="dispatch(${Pe});event.stopPropagation()">Initiate recovery sequence</button>`].join("\n");return ae(n)}case"play":return fo();case"outro":return ae(ro);}});let uo=document.styleSheets[0],go=20,yo=new Intl.NumberFormat("en",{style:"percent"});for(let e=0;20>e;e++)uo.insertRule(`
        @keyframes n${e} {
            ${Array(go).fill(1).map((e,t)=>`
                ${yo.format(t/go)} {
                    clip-path: inset(
                        ${yo.format(Math.random())} 0
                        ${yo.format(Math.random())}
                    );
                }
            `).join("")}
        }
    `),uo.insertRule(`
        .g2.n${e} {
            animation: n${e} ${5*Math.random()}s linear infinite alternate;
        }
    `),uo.insertRule(`
        .g3.n${e} {
            animation: n${e} ${5*Math.random()}s linear infinite alternate;
        }
    `);Qt(po,document.querySelector("#root")),window.dispatch=to})();
